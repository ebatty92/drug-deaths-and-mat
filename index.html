<!DOCTYPE html>
<html>

<head>
  <meta charset=utf-8 />
  <title>Title</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

  <link href='https://api.mapbox.com/mapbox-assembly/v0.21.2/assembly.min.css' rel='stylesheet'>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" />
  <link href='https://fonts.googleapis.com/css?family=Work+Sans:400,500,600' rel='stylesheet' type='text/css'>
  <style>
    /* display none for layout but be careful of license restrictions */
    .mapbox-logo, .leaflet-control-attribution {
        display: none; 
    }

    .legend-large, .legend-small {
        border-radius: 50%; /* making the border-radius of a square div element 50% makes it appear as a circle */
    }

    hr.small, hr.large {
        width: 83px;
        position: absolute;
        top: -8px;
        left: 55px;
        border: 1px dashed #ccc; /* overwrite assembly.css rule */
        margin-top: 8px; /* overwrite assembly.css rule */
    }

    .mat {
        color: #6E77B0;
    }

    #info {     
        z-index: 1000; 
    }

    body {
        font-family: "Work Sans", sans-serif;
    }  
  </style>
</head>

<body>
  <div class='flex-parent viewport-full relative scroll-hidden'>
    <div class='flex-child w-full w300-ml absolute static-ml left bottom'>
      <div class='flex-parent flex-parent--column viewport-third h-full-ml hmax-full bg-orange-faint py18 px12'>
        <div class='flex-child flex-child--grow px12 py12 bg-orange-faint scroll-auto'>
          <h1 class='txt-h2 color-green-light mb6'>Title</h1>
          <p class='txt-bold'>Content:
            <li class='txt-bold'>Content</li>
            <li class='txt-bold'>Content</li>
          </p>
        </div>
        <footer class='px12 py12 bg-green-faint txt-s'>
          <ul>
            <li class='txt-m'>Explore the raw
              <a class='link color-orange' target="_blank" href='https://www.opendata.go.ke/datasets/national-boys-and-girls-enrollments-per-class-for-primary-school-education?selectedAttribute=Year'>Data</a>
            </li>
            <li class='txt-m'>Map authored by
              <a class='link color-orange' target="_blank" href='https://ebatty92.github.io/'>Evan Batty</a>
            </li>
          </ul>
        </footer>
      </div>
    </div>
    <div class='flex-child flex-child--grow viewport-twothirds viewport-full-ml'>
      <div id="map" class='viewport-twothirds viewport-full-ml'></div>
    </div>
  </div>

  <!-- grade level display -->
  <div id='label' class='py6 px12 bg-green-faint border border--gray-light round relative'>
    <p class='grade txt-bold txt-h4'>Year:
      <span></span>
    </p>
  </div>

  <!-- ui slider -->
  <div id='slider' class='range w240 bg-green-faint round-ml px12'>
    <input type='range' min="2004" , max="2016" , value="2004" , step="1" />
  </div>

  <!-- legend -->
  <div id='legend' class='bg-green-faint round px12 py12 relative'>
    <h3 class='txt-bold txt-h4 mb12 w180'>Number of MAT facilities by county</h3>
    <div class='legend-circles relative w180'>
      <div class="legend-large border border--gray-light absolute"></div>
      <div class="legend-small border border--gray-light absolute"></div>
      <div class="legend-large-label txt-m absolute"></div>
      <div class="legend-small-label txt-m absolute"></div>
    </div>
  </div>

  <!-- ui info panel -->
  <div id='info' class='py6 px12 bg-white border border--gray-light round absolute w240'> <!-- class of "none" prevents the info window from displaying until the user mouses over a feature -->
    <p>County:
      <span></span>
    </p>
    <p class='mat'>Facilities offering some MAT
      <span></span>:
      <span class='txt-1 txt-bold'></span>
    </p>
    <hr class='txt-hr'>
    <p class='my6'>Estimated Death Rate Trend: 2004 &ndash; 2016</p>
    <p class='my6'><span class='deathspark'></span></p>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script async defer src="https://api.mapbox.com/mapbox-assembly/v0.21.2/assembly.js"></script>
  <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"></script>
  <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.3.1/leaflet-omnivore.min.js'></script>
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-sparklines/2.1.2/jquery.sparkline.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/1.3.5/chroma.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.3.6/papaparse.min.js"></script>

  <script>
    var map = L.map('map', {
        zoomSnap: .1,
        center: [-80, 30],
        zoom: 6,
        minZoom: 6,
        maxZoom: 9,
    });

    var accessToken = 'pk.eyJ1IjoiZWJhdHR5OTIiLCJhIjoiY2pvNG9ncWczMDFhejN2cDVvemwyZzQ3MyJ9.dpFoYxYhhqKYeIXPvZSg6A'

    L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=' + accessToken, {
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
        maxZoom: 18,
        id: 'mapbox.light',
        accessToken: accessToken
    }).addTo(map);


    // use omnivore to load the CSV data
    omnivore.csv('data/county_death_mat.csv')
        .on('ready', function (e) {
        // access to the GeoJSON here!
        drawMap(e.target.toGeoJSON());
        })
        .on('error', function (e) {
      console.log(e.error[0].message);
    });

    $.getJSON("data/final_data.json", function(poly) {
        drawMap(poly); // draw the map using GeoJSON data
    });


    function drawMap(data, poly, currentYear){

        // access to data here
        var options = {
            pointToLayer: function (feature, ll) {
                return L.circleMarker(ll, {
                    opacity: 1,
                    weight: 2,
                    fillOpacity: 0,
                })
            }
        }

        // create 1 separate layer from GeoJSON data
        var matLayer = L.geoJson(data, options).addTo(map);

        matLayer.setStyle({
            color: '#6E77B0',
 
        });

        var deathLayer = L.geoJSON(data, {
            style: function (poly) {
                return {
                    color: 'black',
                    weight: 1,
                    fillOpacity: 1,
                    fillColor: '#1f78b4'
                };
            }   
        }).addTo(map);

		map.fitBounds(deathLayer.getBounds(), {
            zoom: 2
		});
    

        resizeCircles(matLayer, 2004);

        sequenceUI(matLayer);

        addLabel(currentYear);

    } /// end drawMap()

    function calcRadius(val) {

        var radius = Math.sqrt(val / Math.PI);
        return radius * 20; // adjust .5 as a scale factor
  
    }

    function resizeCircles(matLayer, currentYear) {
        matLayer.eachLayer(function (layer) {

            // shortcut to props
            var props = layer.feature.properties;

            // if the number is zero
            if(+layer.feature.properties['smat_' + currentYear] == 0) {
                // hide the layer
                layer.setStyle({
                    opacity: 0
                })
            // otherwise show the layer
            } else {
                layer.setStyle({
                    opacity: 1
                })
                // and adjust the radius
                var radius =
                    calcRadius (+layer.feature.properties['smat_' + currentYear]);
                layer.setRadius(radius);
            }
        });

        // update hover window with current year
        retrieveInfo(matLayer, currentYear);
        addLabel(currentYear);
    }

    function sequenceUI(matLayer) {
        // sequenceUI function body

        // create Leaflet control for the slider
        var sliderControl = L.control({
            position: 'bottomleft'
        });

        sliderControl.onAdd = function (map) {

            var controls = L.DomUtil.get("slider");

            L.DomEvent.disableScrollPropagation(controls);
            L.DomEvent.disableClickPropagation(controls);

            return controls;

        }

        // add it to the map
        sliderControl.addTo(map);

        //select the slider's input and listen for change
        $('#slider input[type=range]')
            .on('input', function () {

            // current value of slider is current year
            var currentYear = this.value;

            // resize the circles with updated year
            resizeCircles(matLayer, currentYear);
      
            });

    }
/*
    function drawLegend(data) {
        // drawLegend body

        // create Leaflet control for the legend
        var legendControl = L.control({
            position: 'bottomright'
       }); 

        // when the control is added to the map
        legendControl.onAdd = function (map) {

        // select the legend using id attribute of legend
        var legend = L.DomUtil.get("legend");

            // disable scroll and click functionality 
            L.DomEvent.disableScrollPropagation(legend);
            L.DomEvent.disableClickPropagation(legend);

        // return the selection
        return legend;

        }

        legendControl.addTo(map);

        // loop through all features 
        var dataValues = data.features.map(function (mat) {
            // for each year in a county
            for (var year in county.properties) {
                // shorthand to each value
                var value = county.properties[smat];
                // if the value can be converted to a number
                    if (+value) {
                    // return the value to the array
                    return +value;
                }
            }
        });
   
        // sort our array
        var sortedValues = dataValues.sort(function(a,b) {
            return b - a;
        });

        // round the highest number and use as our large circle diameter
        var maxValue = Math.round(sortedValues[0] / 1000) * 1000;
    
        // calc diameters
        var largeDiameter = calcRadius(maxValue) * 2,
            smallDiameter = largeDiameter / 2;
    
        // select our circles container and set the height
        $(".legend-circles").css('height', largeDiameter.toFixed());

        // set width and height for large circle
        $('.legend-large').css({
            'width': largeDiameter.toFixed(),
            'height': largeDiameter.toFixed(),
        })
        // set width and height for small circle position
        $('.legend-small').css({
            'width': smallDiameter.toFixed(),
            'height': smallDiameter.toFixed(),
            'top': largeDiameter - smallDiameter,
            'left': smallDiameter / 2
        })

        // label the max and median value
        $(".legend-large-label").html(maxValue.toLocaleString());
        $(".legend-small-label").html((maxValue / 2).toLocaleString());

        // adjust the position of the large based on size of circle
        $(".legend-large-label").css({
        'top': -11,
        'left': largeDiameter + 30,
        });

        // adjust the position of the large based on size of circle
        $(".legend-small-label").css({
            'top': smallDiameter - 11,
            'left': largeDiameter + 30
        });

        // insert a couple hr elements and use to connect value label to top of each circle
        $("<hr class='large'>").insertBefore(".legend-large-label")
        $("<hr class='small'>").insertBefore(".legend-small-label").css('top', largeDiameter - smallDiameter - 8);
  
    }
*/

    function retrieveInfo(matLayer, currentYear) {
        //function body
    
        // select the element and reference with variable
        // and hide it from view initially
        var info = $('#info').hide();

        // since the matLayer is on top, use to detect mouseover events
        matLayer.on('mouseover', function (e) {
            
            // access properties = e.layer.feature.properties;
            var props = e.layer.feature.properties;

          if(+e.layer.feature.properties['smat_' + currentYear] == 0) {
                // hide the tooltip
                info.hide();
                
          // otherwise show the tooltip
          } else {

            //remove the none class to display and show
            info.show();


            // populate HTML elements with relevant info
            $('#info span').html(props.county);
            $(".mat span:first-child").html('(year ' + currentYear + ')');
            $(".mat span:last-child").html(Number(props['smat_' + currentYear]).toLocaleString());

            // raise opacity level as visual affordance
            e.layer.setStyle({
            fillOpacity: .6
            });

            // empty arrays for death values
            var deathValues = [];
      
            // loop through the years and push values into those arrays
            for (var i = 2004; i <= 2016; i++) {
                deathValues.push(props['ave_death_' + i]);
            }

            $('.deathspark').sparkline(deathValues, {
                width: '200px',
                height: '30px',
                lineColor: '#D96D02',
                fillColor: '#d98939',
                spotRadius: 0,
                lineWidth: 2
            });
          }
        });
    
        // hide the info panel when mousing off layergroup and remove affordance opacity
        matLayer.on('mouseout', function(e) {

            // hide the info panel
            info.hide();

            // reset the layer style
            e.layer.setStyle({
                fillOpacity: 0
            });
        });

        // when the mouse moves on the document
        $(document).mousemove(function(e) {
            // first offset from the mouse position of the info window
            info.css({
                "left": e.pageX + 6,
                "top": e.pageY - info.height() - 25
            });

            // if it crashes into the top, flip it lower right
            if (info.offset().top < 4) {
                info.css({
                    "top": e.pageY + 15
                });
            }
            // if it crashes into the right, flip it to the left
            if (info.offset().left + info.width() >= $(document).width() - 40) {
                info.css({
                    "left": e.pageX - info.width() - 80
                });
            }
        });
    }


    function addLabel (currentYear) {
        // create Leaflet control for the legend
        var labelControl = L.control({
          position: 'bottomleft'
        });
    
        // when the control is added to the map
        labelControl.onAdd = function (map) {
    
          // select the legend using id attribute of legend
          var label = L.DomUtil.get("label");
    
          // disable scroll and click functionality 
          L.DomEvent.disableScrollPropagation(label);
          L.DomEvent.disableClickPropagation(label);
    
        // return the selection
        return label;
    
        }
    
        labelControl.addTo(map);

        // access properties = e.layer.feature.properties;

        // populate HTML elements with relevant info
        $(".year span").html(currentYear);
 
    }

  </script>

</body>

</html>